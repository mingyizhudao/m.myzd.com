$(function(){$.validator.addMethod("isMobile",function(value,element){var length=value.length;var mobile=/^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;return this.optional(element)||(length==11&&mobile.test(value))},"请填写正确的手机号码");var btnUploadSelector="#btnSubmit",domForm=$("#booking-form"),btnSubmit=$("#btnSubmit"),$wrap=$("#uploader"),$queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$statusBar=$wrap.find(".statusBar"),$info=$statusBar.find(".info"),$upload=btnSubmit,$placeHolder=$wrap.find(".placeholder"),$progress=$statusBar.find(".progress").hide(),fileCount=0,fileSize=0,fileParam={"id":"1","name":"1"},uploadReturnUrl=domForm.attr("data-url-return"),actionUrl="",urlUploadFile=domForm.attr("data-url-uploadFile"),ratio=window.devicePixelRatio||1,thumbnailWidth=110*ratio,thumbnailHeight=110*ratio,state="pedding",percentages={},supportTransition=(function(){var s=document.createElement("p").style,r="transition" in s||"WebkitTransition" in s||"MozTransition" in s||"msTransition" in s||"OTransition" in s;s=null;return r})(),uploader;uploaderCorp;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}uploader=WebUploader.create({pick:{id:"#filePicker",innerHTML:"&nbsp;选择图片"},dnd:"#uploader .queueList",paste:document.body,accept:{title:"Images",extensions:"jpg,jpeg,png,gif",mimeTypes:"image/*",},swf:"webuploader/Uploader.swf",disableGlobalDnd:true,chunked:true,server:urlUploadFile,fileNumLimit:10,fileSizeLimit:10*1024*1024,fileSingleSizeLimit:100*1024*1024});uploader.addButton({id:"#filePicker2",label:"&nbsp;继续添加"});function addFile(file){var $li=$('<li id="'+file.id+'">'+'<p class="title">'+file.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),$btns=$('<div class="file-panel">'+'<span class="cancel">删除</span>').appendTo($li),$prgress=$li.find("p.progress span"),$wrap=$li.find("p.imgWrap"),$info=$('<p class="error"></p>'),showError=function(code){switch(code){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}$info.text(text).appendTo($li)};if(file.getStatus()==="invalid"){showError(file.statusText)}else{$wrap.text("预览中");uploader.makeThumb(file,function(error,src){if(error){$wrap.text("不能预览");return}var img=$('<img src="'+src+'">');$wrap.empty().append(img)},thumbnailWidth,thumbnailHeight);percentages[file.id]=[file.size,0];file.rotation=0}file.on("statuschange",function(cur,prev){if(prev==="progress"){$prgress.hide().width(0)}else{if(prev==="queued"){$li.off("mouseenter mouseleave");$btns.remove()}}if(cur==="error"||cur==="invalid"){console.log(file.statusText);showError(file.statusText);percentages[file.id][1]=1}else{if(cur==="interrupt"){showError("interrupt")}else{if(cur==="queued"){percentages[file.id][1]=0}else{if(cur==="progress"){$info.remove();$prgress.css("display","block")}else{if(cur==="complete"){$li.append('<span class="success"></span>')}}}}}$li.removeClass("state-"+prev).addClass("state-"+cur)});$li.on("mouseenter",function(){$btns.stop().animate({height:30})});$li.on("mouseleave",function(){$btns.stop().animate({height:0})});$btns.on("click","span",function(){var index=$(this).index(),deg;switch(index){case 0:uploader.removeFile(file);return;case 1:file.rotation+=90;break;case 2:file.rotation-=90;break}if(supportTransition){deg="rotate("+file.rotation+"deg)";$wrap.css({"-webkit-transform":deg,"-mos-transform":deg,"-o-transform":deg,"transform":deg})}else{$wrap.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((file.rotation/90)%4+4)%4)+")")}});$li.appendTo($queue)}function removeFile(file){var $li=$("#"+file.id);delete percentages[file.id];updateTotalProgress();$li.off().find(".file-panel").off().end().remove()}function updateTotalProgress(){var loaded=0,total=0,spans=$progress.children(),percent;$.each(percentages,function(k,v){total+=v[0];loaded+=v[0]*v[1]});percent=total?loaded/total:0;spans.eq(0).text(Math.round(percent*100)+"%");spans.eq(1).css("width",Math.round(percent*100)+"%");updateStatus()}function updateStatus(){var text="",stats;if(state==="ready"){text="选中"+fileCount+"张图片，共"+WebUploader.formatSize(fileSize)+"。"}else{if(state==="confirm"){stats=uploader.getStats();if(stats.uploadFailNum){text="已成功上传"+stats.successNum+"张图片，"+stats.uploadFailNum+'张图片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{stats=uploader.getStats();text="共"+fileCount+"张（"+WebUploader.formatSize(fileSize)+"），已上传"+stats.successNum+"张";if(stats.uploadFailNum){text+="，失败"+stats.uploadFailNum+"张"}}}$info.html(text)}function setState(val){var file,stats;if(val===state){return}$upload.removeClass("state-"+state);$upload.addClass("state-"+val);state=val;switch(state){case"pedding":$placeHolder.removeClass("element-invisible");$queue.parent().removeClass("filled");$queue.hide();$statusBar.addClass("element-invisible");
uploader.refresh();break;case"ready":$placeHolder.addClass("element-invisible");$("#filePicker2").removeClass("element-invisible");$queue.parent().addClass("filled");$queue.show();$statusBar.removeClass("element-invisible");uploader.refresh();break;case"confirm":$progress.hide();$upload.addClass("disabled");$("#filePicker2").addClass("element-invisible");stats=uploader.getStats();if(stats.successNum&&!stats.uploadFailNum){setState("finish");return}break;case"finish":stats=uploader.getStats();if(stats.successNum){J.popup({html:'<div><div class="popup-title">提示</div><div class="popup-content"><h4>提交成功！</h4><div class="mt20"><a data-target="link" href="'+uploadReturnUrl+'" class="btn btn-yes btn-block">确定</a></div></div></div>',pos:"center"})}else{location.reload()}break}updateStatus()}uploader.onUploadProgress=function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress span");$percent.css("width",percentage*100+"%");percentages[file.id][1]=percentage;updateTotalProgress()};uploader.onFileQueued=function(file){fileCount++;fileSize+=file.size;if(fileCount===1){$placeHolder.addClass("element-invisible");$statusBar.show()}addFile(file);setState("ready");updateTotalProgress()};uploader.onFileDequeued=function(file){fileCount--;fileSize-=file.size;if(!fileCount){setState("pedding")}removeFile(file);updateTotalProgress()};uploader.on("all",function(type){var stats;switch(type){case"uploadFinished":setState("confirm");break;case"startUpload":setState("uploading");break}});uploader.onError=function(code){var errorinfo;switch(code){case"F_DUPLICATE":errorinfo="文件名重复!";break;case"F_EXCEED_SIZE":errorinfo="图片过大!";break;case"Q_EXCEED_SIZE_LIMIT":errorinfo="图片队列总大小过大!";break;case"Q_EXCEED_NUM_LIMIT":errorinfo="文件数量过多!";break;case"Q_TYPE_DENIED":errorinfo="请选择jpg/jpeg/png或gif格式的图片!";break}J.showToast(errorinfo,"",2000)};uploader.on("startUpload",function(){uploader.option("formData",{"booking[id]":fileParam.id,})});uploader.on("uploadFinished",function(file,data){});uploader.on("uploadSuccess",function(file,data){});uploader.on("uploadError",function(file,data){});uploader.on("uploadAccept",function(file,data){if(data.status!="ok"){return false}});$upload.on("click",function(){if($(this).hasClass("disabled")||$(this).hasClass("ui-state-disabled")){return false}formSubmit()});$info.on("click",".retry",function(){uploader.retry()});$info.on("click",".ignore",function(){});$upload.addClass("state-"+state);updateTotalProgress();function formSubmit(){if(getFileCountCorp()==0){$(".corpTip").show();setTimeout(function(){$(".corpTip").hide()},1000)}else{var urlCheckCode=domForm.attr("data-checkCode");var formdata=domForm.serializeArray();var bool=validator.form();if(bool){var captchaCode=$("#booking_captcha_code").val();$.ajax({type:"post",url:urlCheckCode+"?co_code="+captchaCode,data:formdata,success:function(data){if(data.status=="ok"){formAjaxSubmit()}else{$("#booking_captcha_code-error").remove();$("#captchaCode").after('<div id="booking_captcha_code-error" class="error">'+data.error+"</div>");$("#booking_captcha_code").focus()}}})}}}var validator=domForm.validate({rules:{"booking[corporate_name]":{required:true,maxlength:50},"booking[corp_staff_rel]":{required:true},"booking[doctor_name]":{maxlength:50},"booking[hospital_name]":{maxlength:50},"booking[hp_dept_name]":{maxlength:50},"booking[contact_name]":{required:true,maxlength:50},"booking[mobile]":{required:true,isMobile:true},"booking[captcha_code]":{required:true},"booking[verify_code]":{required:true,digits:true,maxlength:6,minlength:6},"booking[disease_name]":{required:true,maxlength:50},"booking[disease_detail]":{required:true,minlength:10,maxlength:1000},"booking[remark]":{required:true,maxlength:500}},messages:{"booking[corporate_name]":{required:"请填写医生企业名称",maxlength:"企业名称太长"},"booking[corp_staff_rel]":{required:"请选择与患者的关系"},"booking[doctor_name]":{maxlength:"姓名太长"},"booking[hospital_name]":{maxlength:"医院名称太长"},"booking[hp_dept_name]":{maxlength:"科室名称太长"},"booking[contact_name]":{required:"请填写患者姓名",maxlength:"患者姓名太长"},"booking[captcha_code]":{required:"请填写图形验证码"},"booking[mobile]":{required:"请填写手机号码",isMobile:"请输入正确的中国手机号码"},"booking[verify_code]":{required:"请输入验证码",digits:"验证码不正确",maxlength:"验证码不正确",minlength:"验证码不正确"},"booking[disease_name]":{required:"请填写疾病诊断",maxlength:"请将字数控制在50以内"},"booking[disease_detail]":{required:"请填写病情",minlength:"请至少填写10个字",maxlength:"请将字数控制在1000以内"}},errorElement:"div",errorPlacement:function(error,element){$("div.error").text("");error.appendTo(element.parent())},submitHandler:function(){}});function formAjaxSubmit(){actionUrl=domForm.attr("data-actionUrl");returnUrl=domForm.attr("data-url-return");var uploaderCorp=getUploaderCorp();var formdata=domForm.serializeArray();$.ajax({type:"post",url:actionUrl,data:formdata,success:function(data){if(data.status=="ok"){fileParam.id=data.booking.id;if(uploaderCorp.state=="ready"){uploaderCorp.upload()}if(state=="ready"){uploader.upload()}else{J.popup({html:'<div><div class="popup-title">提示</div><div class="popup-content"><h4>提交成功！</h4><div class="mt20"><a data-target="link" href="'+returnUrl+'" class="btn btn-yes btn-block">确定</a></div></div></div>',pos:"center"})
}}else{domForm.find("div.error").remove();isfocus=true;for(error in data.errors){errerMsg=data.errors[error];inputKey="#booking_"+error;$(inputKey).focus();$(inputKey).after("<div class='error'>"+errerMsg+"</div> ")}}},error:function(XmlHttpRequest,textStatus,errorThrown){console.log(XmlHttpRequest);console.log(textStatus);console.log(errorThrown)},complete:function(){}})}});