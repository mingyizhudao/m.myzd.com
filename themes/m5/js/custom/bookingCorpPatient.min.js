$(function(){$.validator.addMethod("isMobile",function(I,G){var H=I.length;var F=/^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;return this.optional(G)||(H==11&&F.test(I))},"请填写正确的手机号码");var g="#btnSubmit",k=$("#booking-form"),x=$("#btnSubmit"),s=$("#uploader"),l=$('<ul class="filelist"></ul>').appendTo(s.find(".queueList")),y=s.find(".statusBar"),d=y.find(".info"),b=x,i=s.find(".placeholder"),q=y.find(".progress").hide(),C=0,p=0,A={"id":"1","name":"1"},B=k.attr("data-url-return"),n="",r=k.attr("data-url-uploadFile"),m=window.devicePixelRatio||1,o=110*m,a=110*m,h="pedding",E={},w=(function(){var F=document.createElement("p").style,G="transition" in F||"WebkitTransition" in F||"MozTransition" in F||"msTransition" in F||"OTransition" in F;F=null;return G})(),u;uploaderCorp;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}u=WebUploader.create({pick:{id:"#filePicker",innerHTML:"&nbsp;选择图片"},dnd:"#uploader .queueList",paste:document.body,accept:{title:"Images",extensions:"jpg,jpeg,png,gif",mimeTypes:"image/*",},swf:"webuploader/Uploader.swf",disableGlobalDnd:true,chunked:true,server:r,fileNumLimit:10,fileSizeLimit:10*1024*1024,fileSingleSizeLimit:100*1024*1024});u.addButton({id:"#filePicker2",label:"&nbsp;继续添加"});function v(L){var M=$('<li id="'+L.id+'">'+'<p class="title">'+L.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),I=$('<div class="file-panel">'+'<span class="cancel">删除</span>').appendTo(M),H=M.find("p.progress span"),G=M.find("p.imgWrap"),K=$('<p class="error"></p>'),F=function(N){switch(N){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}K.text(text).appendTo(M)};if(L.getStatus()==="invalid"){F(L.statusText)}else{G.text("预览中");u.makeThumb(L,function(O,P){if(O){G.text("不能预览");return}var N=$('<img src="'+P+'">');G.empty().append(N)},o,a);E[L.id]=[L.size,0];L.rotation=0}L.on("statuschange",function(O,N){if(N==="progress"){H.hide().width(0)}else{if(N==="queued"){M.off("mouseenter mouseleave");I.remove()}}if(O==="error"||O==="invalid"){console.log(L.statusText);F(L.statusText);E[L.id][1]=1}else{if(O==="interrupt"){F("interrupt")}else{if(O==="queued"){E[L.id][1]=0}else{if(O==="progress"){K.remove();H.css("display","block")}else{if(O==="complete"){M.append('<span class="success"></span>')}}}}}M.removeClass("state-"+N).addClass("state-"+O)});M.on("mouseenter",function(){I.stop().animate({height:30})});M.on("mouseleave",function(){I.stop().animate({height:0})});I.on("click","span",function(){var N=$(this).index(),O;switch(N){case 0:u.removeFile(L);return;case 1:L.rotation+=90;break;case 2:L.rotation-=90;break}if(w){O="rotate("+L.rotation+"deg)";G.css({"-webkit-transform":O,"-mos-transform":O,"-o-transform":O,"transform":O})}else{G.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((L.rotation/90)%4+4)%4)+")")}});M.appendTo(l)}function z(F){var G=$("#"+F.id);delete E[F.id];e();G.off().find(".file-panel").off().end().remove()}function e(){var F=0,I=0,G=q.children(),H;$.each(E,function(L,K){I+=K[0];F+=K[0]*K[1]});H=I?F/I:0;G.eq(0).text(Math.round(H*100)+"%");G.eq(1).css("width",Math.round(H*100)+"%");f()}function f(){var G="",F;if(h==="ready"){G="选中"+C+"张图片，共"+WebUploader.formatSize(p)+"。"}else{if(h==="confirm"){F=u.getStats();if(F.uploadFailNum){G="已成功上传"+F.successNum+"张图片，"+F.uploadFailNum+'张图片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{F=u.getStats();G="共"+C+"张（"+WebUploader.formatSize(p)+"），已上传"+F.successNum+"张";if(F.uploadFailNum){G+="，失败"+F.uploadFailNum+"张"}}}d.html(G)}function t(H){var G,F;if(H===h){return}b.removeClass("state-"+h);b.addClass("state-"+H);h=H;switch(h){case"pedding":i.removeClass("element-invisible");l.parent().removeClass("filled");l.hide();y.addClass("element-invisible");u.refresh();break;case"ready":i.addClass("element-invisible");$("#filePicker2").removeClass("element-invisible");l.parent().addClass("filled");l.show();y.removeClass("element-invisible");u.refresh();break;case"confirm":q.hide();b.addClass("disabled");$("#filePicker2").addClass("element-invisible");F=u.getStats();if(F.successNum&&!F.uploadFailNum){t("finish");return}break;case"finish":F=u.getStats();if(F.successNum){J.popup({html:'<div><div class="popup-title">提示</div><div class="popup-content"><h4>提交成功！</h4><div class="mt20"><a data-target="link" href="'+B+'" class="btn btn-yes btn-block">确定</a></div></div></div>',pos:"center"})}else{location.reload()}break}f()}u.onUploadProgress=function(H,F){var I=$("#"+H.id),G=I.find(".progress span");G.css("width",F*100+"%");E[H.id][1]=F;e()};u.onFileQueued=function(F){C++;p+=F.size;if(C===1){i.addClass("element-invisible");y.show()}v(F);t("ready");e()};u.onFileDequeued=function(F){C--;p-=F.size;if(!C){t("pedding")}z(F);e()};u.on("all",function(G){var F;switch(G){case"uploadFinished":t("confirm");
break;case"startUpload":t("uploading");break}});u.onError=function(G){var F;switch(G){case"F_DUPLICATE":F="文件名重复!";break;case"F_EXCEED_SIZE":F="图片过大!";break;case"Q_EXCEED_SIZE_LIMIT":F="图片队列总大小过大!";break;case"Q_EXCEED_NUM_LIMIT":F="文件数量过多!";break;case"Q_TYPE_DENIED":F="请选择jpg/jpeg/png或gif格式的图片!";break}J.showToast(F,"",2000)};u.on("startUpload",function(){u.option("formData",{"booking[id]":A.id,})});u.on("uploadFinished",function(F,G){});u.on("uploadSuccess",function(F,G){});u.on("uploadError",function(F,G){});u.on("uploadAccept",function(F,G){if(G.status!="ok"){return false}});b.on("click",function(){if($(this).hasClass("disabled")||$(this).hasClass("ui-state-disabled")){return false}D()});d.on("click",".retry",function(){u.retry()});d.on("click",".ignore",function(){});b.addClass("state-"+h);e();function D(){if(getFileCountCorp()==0){$(".corpTip").show();setTimeout(function(){$(".corpTip").hide()},1000)}else{var H=k.attr("data-checkCode");var F=k.serializeArray();var G=j.form();if(G){var I=$("#booking_captcha_code").val();$.ajax({type:"post",url:H+"?co_code="+I,data:F,success:function(K){if(K.status=="ok"){c()}else{$("#booking_captcha_code-error").remove();$("#captchaCode").after('<div id="booking_captcha_code-error" class="error">'+K.error+"</div>");$("#booking_captcha_code").focus()}}})}}}var j=k.validate({rules:{"booking[corporate_name]":{required:true,maxlength:50},"booking[corp_staff_rel]":{required:true},"booking[doctor_name]":{maxlength:50},"booking[hospital_name]":{maxlength:50},"booking[hp_dept_name]":{maxlength:50},"booking[contact_name]":{required:true,maxlength:50},"booking[mobile]":{required:true,isMobile:true},"booking[captcha_code]":{required:true},"booking[verify_code]":{required:true,digits:true,maxlength:6,minlength:6},"booking[disease_name]":{required:true,maxlength:50},"booking[disease_detail]":{required:true,minlength:10,maxlength:1000},"booking[remark]":{required:true,maxlength:500}},messages:{"booking[corporate_name]":{required:"请填写医生企业名称",maxlength:"企业名称太长"},"booking[corp_staff_rel]":{required:"请选择与患者的关系"},"booking[doctor_name]":{maxlength:"姓名太长"},"booking[hospital_name]":{maxlength:"医院名称太长"},"booking[hp_dept_name]":{maxlength:"科室名称太长"},"booking[contact_name]":{required:"请填写患者姓名",maxlength:"患者姓名太长"},"booking[captcha_code]":{required:"请填写图形验证码"},"booking[mobile]":{required:"请填写手机号码",isMobile:"请输入正确的中国手机号码"},"booking[verify_code]":{required:"请输入验证码",digits:"验证码不正确",maxlength:"验证码不正确",minlength:"验证码不正确"},"booking[disease_name]":{required:"请填写疾病诊断",maxlength:"请将字数控制在50以内"},"booking[disease_detail]":{required:"请填写病情",minlength:"请至少填写10个字",maxlength:"请将字数控制在1000以内"}},errorElement:"div",errorPlacement:function(F,G){$("div.error").text("");F.appendTo(G.parent())},submitHandler:function(){}});function c(){disabledBtn(x);n=k.attr("data-actionUrl");returnUrl=k.attr("data-url-return");var H=getUploaderCorp();var G=k.serializeArray();var F=structure_formdata("booking",G);var I=do_encrypt(F,pubkey);var K={param:I};$.ajax({type:"post",url:n,data:K,success:function(L){if(L.status=="ok"){A.id=L.booking.id;if(H.state=="ready"){H.upload()}if(h=="ready"){u.upload()}else{J.popup({html:'<div><div class="popup-title">提示</div><div class="popup-content"><h4>提交成功！</h4><div class="mt20"><a data-target="link" href="'+returnUrl+'" class="btn btn-yes btn-block">确定</a></div></div></div>',pos:"center"})}}else{k.find("div.error").remove();isfocus=true;for(error in L.errors){errerMsg=L.errors[error];inputKey="#booking_"+error;$(inputKey).focus();$(inputKey).after("<div class='error'>"+errerMsg+"</div> ")}enableBtn(x)}},error:function(L,N,M){enableBtn(x);console.log(L);console.log(N);console.log(M)},complete:function(){}})}});