$(function(){var d=$("#booking-form"),g=$("#btnSubmit"),f=d.attr("data-url-return"),a=d.attr("data-url-uploadFile");g.click(function(){var h=c.form();if(h){b()}});var c=d.validate({rules:{"booking[contact_name]":{required:true},"booking[date_start]":{required:true},"booking[date_end]":{required:true},"booking[disease_name]":{required:true,maxlength:50},"booking[disease_detail]":{required:true,maxlength:1000}},messages:{"booking[contact_name]":{required:"请填写真实姓名",maxlength:"请将字数控制在50以内"},"booking[date_start]":{required:"请选择开始日期"},"booking[date_end]":{required:"请选择截止日期"},"booking[disease_name]":{required:"请填写疾病名称",maxlength:"病情太长（最多50个字）"},"booking[disease_detail]":{required:"请填写疾病描述",maxlength:"病情太长（最多1000个字）",minlength:"病情太短（最少10个字）"}},errorElement:"div",errorPlacement:function(h,i){i.parents(".ui-field-contain").find("div.error").remove();h.appendTo(i.parents(".ui-field-contain"))}});function b(){disabledBtnAndriod(g);actionUrl=d.attr("data-actionUrl");var i=d.serializeArray();var h=structure_formdata("booking",i);var j=do_encrypt(h,pubkey);var k={param:j};$.ajax({type:"post",url:actionUrl,data:k,success:function(l){if(l.status=="ok"){var m=$(".MultiFile-applied").length-1;if(m==0){location.href=f+"?refNo="+l.salesOrderRefNo}else{e(l)}}else{d.find("div.error").remove();isfocus=true;for(error in l.errors){errerMsg=l.errors[error];inputKey="#booking_"+error;$(inputKey).focus();$(inputKey).after("<div class='error'>"+errerMsg+"</div> ")}enableBtnAndriod(g)}},error:function(l,n,m){enableBtnAndriod(g);console.log(l);console.log(n);console.log(m)},complete:function(){}})}function e(k){disabledBtnAndriod(g);$(".MultiFile-applied").attr("name","file");var j=0,l=0,i=0;l=$(".MultiFile-applied").length-1;var h={"booking[id]":k.booking.id,"plugin":"ajaxFileUpload"};$(".MultiFile-applied").each(function(){if($(this).val()){var m=$(this).attr("id");$.ajaxFileUpload({url:a,secureuri:false,data:h,fileElementId:m,type:"post",dataType:"json",success:function(o,n){if(o.status=="ok"){j++}},error:function(o,n,p){console.log(o);alert("文件过大,上传失败")},complete:function(){i++;if(l==i){if(j==l){location.href=f+"?refNo="+k.salesOrderRefNo}else{}enableBtnAndriod(g)}}})}})}});