$(function(){var e="#btnSubmit",h=$("#booking-form"),p=$("#btnSubmit"),m=$("#uploader"),i=$('<ul class="filelist"></ul>').appendTo(m.find(".queueList")),q=m.find(".statusBar"),b=q.find(".info"),a=p,f=m.find(".placeholder"),l=q.find(".progress").hide(),t=0,k=0,r={"id":"1","name":"1"},s=h.attr("data-url-return"),j="";urlUploadFile=h.attr("data-url-uploadFile");ratio=window.devicePixelRatio||1,thumbnailWidth=110*ratio,thumbnailHeight=110*ratio,state="pedding",percentages={},supportTransition=(function(){var v=document.createElement("p").style,w="transition" in v||"WebkitTransition" in v||"MozTransition" in v||"msTransition" in v||"OTransition" in v;v=null;return w})(),uploader;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}uploader=WebUploader.create({pick:{id:"#filePicker",innerHTML:"&nbsp;选择图片"},dnd:"#uploader .queueList",accept:{title:"Images",extensions:"jpg,jpeg,png,gif",mimeTypes:"image/*",},swf:"webuploader/Uploader.swf",disableGlobalDnd:true,chunked:true,server:urlUploadFile,fileNumLimit:10,fileSizeLimit:10*1024*1024,fileSingleSizeLimit:100*1024*1024});uploader.addButton({id:"#filePicker2",label:"&nbsp;继续添加"});function o(A){var B=$('<li id="'+A.id+'">'+'<p class="title">'+A.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),y=$('<div class="file-panel">'+'<span class="cancel">删除</span>'+'<span class="rotateRight">向右旋转</span>'+'<span class="rotateLeft">向左旋转</span></div>').appendTo(B),x=B.find("p.progress span"),w=B.find("p.imgWrap"),z=$('<p class="error"></p>'),v=function(C){switch(C){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}z.text(text).appendTo(B)};if(A.getStatus()==="invalid"){v(A.statusText)}else{w.text("预览中");uploader.makeThumb(A,function(D,E){if(D){w.text("不能预览");return}var C=$('<img src="'+E+'">');w.empty().append(C)},thumbnailWidth,thumbnailHeight);percentages[A.id]=[A.size,0];A.rotation=0}A.on("statuschange",function(D,C){if(C==="progress"){x.hide().width(0)}else{if(C==="queued"){B.off("mouseenter mouseleave");y.remove()}}if(D==="error"||D==="invalid"){console.log(A.statusText);v(A.statusText);percentages[A.id][1]=1}else{if(D==="interrupt"){v("interrupt")}else{if(D==="queued"){percentages[A.id][1]=0}else{if(D==="progress"){z.remove();x.css("display","block")}else{if(D==="complete"){B.append('<span class="success"></span>')}}}}}B.removeClass("state-"+C).addClass("state-"+D)});B.on("mouseenter",function(){y.stop().animate({height:30})});B.on("mouseleave",function(){y.stop().animate({height:0})});y.on("click","span",function(){var C=$(this).index(),D;switch(C){case 0:uploader.removeFile(A);return;case 1:A.rotation+=90;break;case 2:A.rotation-=90;break}if(supportTransition){D="rotate("+A.rotation+"deg)";w.css({"-webkit-transform":D,"-mos-transform":D,"-o-transform":D,"transform":D})}else{w.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((A.rotation/90)%4+4)%4)+")")}});B.appendTo(i)}function u(v){var w=$("#"+v.id);delete percentages[v.id];c();w.off().find(".file-panel").off().end().remove()}function c(){var v=0,y=0,w=l.children(),x;$.each(percentages,function(A,z){y+=z[0];v+=z[0]*z[1]});x=y?v/y:0;w.eq(0).text(Math.round(x*100)+"%");w.eq(1).css("width",Math.round(x*100)+"%");d()}function d(){var w="",v;if(state==="ready"){w="选中"+t+"张图片，共"+WebUploader.formatSize(k)+"。"}else{if(state==="confirm"){v=uploader.getStats();if(v.uploadFailNum){w="已成功上传"+v.successNum+"张图片，"+v.uploadFailNum+'张图片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{v=uploader.getStats();w="共"+t+"张（"+WebUploader.formatSize(k)+"），已上传"+v.successNum+"张";if(v.uploadFailNum){w+="，失败"+v.uploadFailNum+"张"}}}b.html(w)}function n(x){var w,v;if(x===state){return}a.removeClass("state-"+state);a.addClass("state-"+x);state=x;switch(state){case"pedding":f.removeClass("element-invisible");i.parent().removeClass("filled");i.hide();q.addClass("element-invisible");uploader.refresh();break;case"ready":f.addClass("element-invisible");$("#filePicker2").removeClass("element-invisible");i.parent().addClass("filled");i.show();q.removeClass("element-invisible");uploader.refresh();break;case"confirm":l.hide();a.addClass("disabled");$("#filePicker2").addClass("element-invisible");v=uploader.getStats();if(v.successNum&&!v.uploadFailNum){n("finish");return}break;case"finish":v=uploader.getStats();if(v.successNum){location.href=s}else{location.reload()}break}d()}uploader.onUploadProgress=function(x,v){var y=$("#"+x.id),w=y.find(".progress span");w.css("width",v*100+"%");percentages[x.id][1]=v;c()};uploader.onFileQueued=function(v){t++;k+=v.size;if(t===1){f.addClass("element-invisible");q.show()}o(v);n("ready");c()};uploader.onFileDequeued=function(v){t--;k-=v.size;if(!t){n("pedding")}u(v);c()};uploader.on("all",function(w){var v;switch(w){case"uploadFinished":n("confirm");break;case"startUpload":n("uploading");
break}});uploader.onError=function(w){var v;switch(w){case"F_DUPLICATE":v="文件名重复!";break;case"F_EXCEED_SIZE":v="图片过大!";break;case"Q_EXCEED_SIZE_LIMIT":v="图片队列总大小过大!";break;case"Q_EXCEED_NUM_LIMIT":v="文件数量过多!";break;case"Q_TYPE_DENIED":v="请选择jpg/jpeg/png或gif格式的图片!";break}$("#tipPage .tipcontent p").html(v);$("#toTip").trigger("click")};uploader.on("startUpload",function(){uploader.option("formData",{"booking[id]":r.id,})});uploader.on("uploadFinished",function(v,w){});uploader.on("uploadSuccess",function(v,w){});uploader.on("uploadError",function(v,w){});uploader.on("uploadAccept",function(v,w){if(w.status!="ok"){return false}});a.on("click",function(){if($(this).hasClass("disabled")||$(this).hasClass("ui-state-disabled")){return false}h.submit()});b.on("click",".retry",function(){uploader.retry()});b.on("click",".ignore",function(){location.href=s});a.addClass("state-"+state);c();var g=h.validate({rules:{"booking[contact_name]":{required:true},"booking[disease_name]":{required:true,maxlength:50},"booking[disease_detail]":{required:true,maxlength:1000}},messages:{"booking[contact_name]":{required:"请填写真实姓名",maxlength:"请将字数控制在50以内"},"booking[disease_name]":{required:"请填写疾病名称",maxlength:"病情太长（最多50个字）"},"booking[disease_detail]":{required:"请填写疾病描述",maxlength:"病情太长（最多1000个字）",minlength:"病情太短（最少10个字）"}},errorElement:"div",errorPlacement:function(v,w){w.parents(".ui-field-contain").find("div.error").remove();v.appendTo(w.parents(".ui-field-contain"))},submitHandler:function(){disabledBtn(p);j=h.attr("data-actionurl");var w=h.serializeArray();var v=structure_formdata("booking",w);var x=do_encrypt(v,pubkey);var y={param:x};h.ajaxSubmit({type:"post",url:j,data:y,success:function(z){console.log(z);if(z.status=="ok"){r.id=z.booking.id;s=s+"?refNo="+z.salesOrderRefNo;if(state=="ready"){uploader.upload()}else{location.href=s}enableBtn(p)}else{h.find("div.error").remove();isfocus=true;for(error in z.errors){errerMsg=z.errors[error];inputKey="#booking_"+error;$(inputKey).focus();$(inputKey).parent().after("<div class='error'>"+errerMsg+"</div> ")}enableBtn(p)}},error:function(z,B,A){enableBtn(p);console.log(z);console.log(B);console.log(A)},complete:function(){}})}});$("#booking-form #booking_date_start").click(function(){$(this).parents(".ui-field-contain").find("div.error").remove()});$("#booking-form #booking_date_end").click(function(){$(this).parents(".ui-field-contain").find("div.error").remove()})});