jQuery(function(){jQuery.validator.addMethod("isMobile",function(k,i){var j=k.length;var h=/^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;return this.optional(i)||(j==11&&h.test(k))},"请填写正确的手机号码");var d=$("#booking-form"),a=d.attr("data-url-uploadFile"),g=d.attr("data-url-return"),f=$("#btnSubmit");f.click(function(){var j=d.attr("data-checkCode");var h=d.serializeArray();var i=c.form();if(i){if($("#checkUser").attr("value")==1){b()}else{var k=$("#booking_captcha_code").val();$.ajax({type:"post",url:j+"?co_code="+k,data:h,success:function(l){if(l.status=="ok"){b()}else{$("#booking_captcha_code-error").remove();$("#captchaCode").after('<div id="booking_captcha_code-error" class="error">'+l.error+"</div>");$("#booking_captcha_code").focus()}}})}}});var c=d.validate({rules:{"booking[doctor_name]":{maxlength:50},"booking[hospital_name]":{maxlength:50},"booking[hp_dept_name]":{maxlength:50},"booking[contact_name]":{required:true,maxlength:50},"booking[captcha_code]":{required:true},"booking[mobile]":{required:true,isMobile:true},"booking[verify_code]":{required:true,digits:true,maxlength:6,minlength:6},"booking[disease_name]":{required:true,maxlength:50},"booking[disease_detail]":{required:true,minlength:10,maxlength:1000},"booking[remark]":{required:true,maxlength:500}},messages:{"booking[doctor_name]":{maxlength:"姓名太长"},"booking[hospital_name]":{maxlength:"医院名称太长"},"booking[hp_dept_name]":{maxlength:"科室名称太长"},"booking[contact_name]":{required:"请填写患者姓名",maxlength:"患者姓名太长"},"booking[captcha_code]":{required:"请填写图形验证码"},"booking[mobile]":{required:"请填写手机号码",isMobile:"请输入正确的中国手机号码"},"booking[verify_code]":{required:"请输入验证码",digits:"验证码不正确",maxlength:"验证码不正确",minlength:"验证码不正确"},"booking[disease_name]":{required:"请填写疾病诊断",maxlength:"请将字数控制在50以内"},"booking[disease_detail]":{required:"请填写病情",minlength:"请至少填写10个字",maxlength:"请将字数控制在1000以内"}},errorElement:"div",errorPlacement:function(h,i){i.parents(".ui-field-contain").find("div.error").remove();h.appendTo(i.parents(".ui-field-contain"))},});function b(){disabledBtnAndriod(f);actionUrl=d.attr("data-actionurl");var i=d.serializeArray();var h=structure_formdata("booking",i);var j=do_encrypt(h,pubkey);var k={param:j};$.ajax({type:"post",url:actionUrl,data:k,success:function(l){if(l.status=="ok"){var m=$(".MultiFile-applied").length-1;if(m==0){location.href=g+"?refNo="+l.salesOrderRefNo;enableBtnAndriod(f)}else{e(l)}}else{d.find("div.error").remove();isfocus=true;for(error in l.errors){errerMsg=l.errors[error];inputKey="#booking_"+error;$(inputKey).focus();$(inputKey).after("<div class='error'>"+errerMsg+"</div> ")}enableBtnAndriod(f)}},error:function(l,n,m){enableBtnAndriod(f);console.log(l);console.log(n);console.log(m)},complete:function(){}})}function e(k){disabledBtnAndriod(f);$(".MultiFile-applied").attr("name","file");var j=0,l=0,i=0;l=$(".MultiFile-applied").length-1;var h={"booking[id]":k.booking.id,"plugin":"ajaxFileUpload"};$(".MultiFile-applied").each(function(){if($(this).val()){var m=$(this).attr("id");$.ajaxFileUpload({url:a,secureuri:false,data:h,fileElementId:m,type:"post",dataType:"json",success:function(o,n){if(o.status=="ok"){j++}},error:function(o,n,p){console.log(o);alert("文件过大,上传失败")},complete:function(){i++;if(l==i){if(j==l){location.href=g+"?refNo="+k.salesOrderRefNo}else{}enableBtnAndriod(f)}}})}})}});