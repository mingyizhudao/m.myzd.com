$(function(){$.validator.addMethod("isMobile",function(n,l){var m=n.length;var k=/^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;return this.optional(l)||(m==11&&k.test(n))},"请填写正确的手机号码");var e=$("#booking-form"),f=e.attr("data-url-uploadFile"),c=e.attr("data-url-uploadCorpFile"),i=e.attr("data-url-return"),d=$("#btnSubmit"),g=0;var a=e.validate({rules:{"booking[corporate_name]":{required:true,maxlength:50},"booking[corp_staff_rel]":{required:true},"booking[doctor_name]":{maxlength:50},"booking[hospital_name]":{maxlength:50},"booking[hp_dept_name]":{maxlength:50},"booking[contact_name]":{required:true,maxlength:50},"booking[captcha_code]":{required:true},"booking[mobile]":{required:true,isMobile:true},"booking[verify_code]":{required:true,digits:true,maxlength:6,minlength:6},"booking[disease_name]":{required:true,maxlength:50},"booking[disease_detail]":{required:true,minlength:10,maxlength:1000},"booking[remark]":{required:true,maxlength:500}},messages:{"booking[corporate_name]":{required:"请填写医生企业名称",maxlength:"企业名称太长"},"booking[corp_staff_rel]":{required:"请选择与患者的关系"},"booking[doctor_name]":{maxlength:"姓名太长"},"booking[hospital_name]":{maxlength:"医院名称太长"},"booking[hp_dept_name]":{maxlength:"科室名称太长"},"booking[contact_name]":{required:"请填写患者姓名",maxlength:"患者姓名太长"},"booking[captcha_code]":{required:"请填写图形验证码"},"booking[mobile]":{required:"请填写手机号码",isMobile:"请输入正确的中国手机号码"},"booking[verify_code]":{required:"请输入验证码",digits:"验证码不正确",maxlength:"验证码不正确",minlength:"验证码不正确"},"booking[disease_name]":{required:"请填写疾病诊断",maxlength:"请将字数控制在50以内"},"booking[disease_detail]":{required:"请填写病情",minlength:"请至少填写10个字",maxlength:"请将字数控制在1000以内"}},errorElement:"div",errorPlacement:function(k,l){l.parents(".ui-field-contain").find("div.error").remove();k.appendTo(l.parents(".ui-field-contain"))},});d.click(function(){var n=$(".patient .MultiFile-applied").length-1;var p=$(".corp .MultiFile-applied").length-1;var q=e.find("#booking_corporate_name").val();if(p==0){$(".corpTip").show();setTimeout(function(){$(".corpTip").hide()},1000)}else{if(!q){$("#booking_corporate_name_show").parents("li").find("div.error").remove();$("#booking_corporate_name_show").after("<div class='error'>请填写医生企业名称</div> ");$("#booking_corporate_name_show").focus();a.form()}else{var m=e.attr("data-checkCode");var k=e.serializeArray();var l=a.form();if(l){var o=$("#booking_captcha_code").val();$.ajax({type:"post",url:m+"?co_code="+o,data:k,success:function(r){if(r.status=="ok"){b()}else{$("#booking_captcha_code-error").remove();$("#captchaCode").after('<div id="booking_captcha_code-error" class="error">'+r.error+"</div>");$("#booking_captcha_code").focus()}}})}}}});function b(){disabledBtnAndriod(d);actionUrl=e.attr("data-actionurl");var l=e.serializeArray();var k=structure_formdata("booking",l);var m=do_encrypt(k,pubkey);var n={param:m};$.ajax({type:"post",url:actionUrl,data:n,success:function(p){if(p.status=="ok"){var o=$(".patient .MultiFile-applied").length-1;h(p);if(o!=0){j(p)}}else{e.find("div.error").remove();$(".form-wrapper").find("div.error").remove();isfocus=true;for(error in p.errors){inputKey="#booking_"+error;if(error=="corporate_name"){inputKey="#booking_"+error+"_show"}errerMsg=p.errors[error];$(inputKey).focus();$(inputKey).after("<div class='error'>"+errerMsg+"</div> ")}enableBtnAndriod(d)}},error:function(o,q,p){enableBtnAndriod(d);console.log(o);console.log(q);console.log(p)},complete:function(){}})}function j(n){disabledBtnAndriod(d);$(".MultiFile-applied").attr("name","file");var m=0,o=0,l=0;o=$(".patient .MultiFile-applied").length-1;corpinputCount=$(".corp .MultiFile-applied").length-1;var k={"booking[id]":n.booking.id,"plugin":"ajaxFileUpload"};$(".patient .MultiFile-applied").each(function(){if($(this).val()){var p=$(this).attr("id");$.ajaxFileUpload({url:f,secureuri:false,data:k,fileElementId:p,type:"post",dataType:"json",success:function(r,q){if(r.status=="ok"){m++}},error:function(r,q,s){console.log(r);enableBtnAndriod(d);alert("文件过大,病历上传失败")},complete:function(){l++;if(o==l){if(m==o){g++;if(g==2){$("#jingle_popup").show();$("#jingle_popup_mask").show();enableBtnAndriod(d)}else{if(o==0&&g==1){$("#jingle_popup").show();$("#jingle_popup_mask").show();enableBtnAndriod(d)}}}else{}}}})}})}function h(n){disabledBtnAndriod(d);$(".MultiFile-applied").attr("name","file");var m=0,o=0,l=0;mrinputCount=$(".patient .MultiFile-applied").length-1;o=$(".corp .MultiFile-applied").length-1;var k={"booking[id]":n.booking.id,"plugin":"ajaxFileUpload"};$(".corp .MultiFile-applied").each(function(){if($(this).val()){var p=$(this).attr("id");$.ajaxFileUpload({url:c,secureuri:false,data:k,fileElementId:p,type:"post",dataType:"json",success:function(r,q){if(r.status=="ok"){m++}},error:function(r,q,s){enableBtnAndriod(d);alert("文件过大,企业工牌照片上传失败")},complete:function(){l++;if(o==l){if(m==o){g++;if(g==2){$("#jingle_popup").show();$("#jingle_popup_mask").show();enableBtnAndriod(d)}else{if(mrinputCount==0&&g==1){$("#jingle_popup").show();$("#jingle_popup_mask").show();
enableBtnAndriod(d)}}}else{}}}})}})}});