$(function(){$.validator.addMethod("isMobile",function(z,x){var y=z.length;var w=/^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;return this.optional(x)||(y==11&&w.test(z))},"请填写正确的手机号码");var f="#btnSubmit",i=$("#booking-form"),q=$("#btnSubmit"),n=$("#uploader"),j=$('<ul class="filelist"></ul>').appendTo(n.find(".queueList")),r=n.find(".statusBar"),c=r.find(".info"),a=q,g=n.find(".placeholder"),m=r.find(".progress").hide(),u=0,l=0,s={"id":"1","name":"1"},t=i.attr("data-url-return"),k="";urlUploadFile=i.attr("data-url-uploadFile");ratio=window.devicePixelRatio||1,thumbnailWidth=110*ratio,thumbnailHeight=110*ratio,state="pedding",percentages={},supportTransition=(function(){var w=document.createElement("p").style,x="transition" in w||"WebkitTransition" in w||"MozTransition" in w||"msTransition" in w||"OTransition" in w;w=null;return x})(),uploader;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}uploader=WebUploader.create({pick:{id:"#filePicker",innerHTML:"&nbsp;选择图片"},dnd:"#uploader .queueList",paste:document.body,accept:{title:"Images",extensions:"jpg,jpeg,png,gif",mimeTypes:"image/*",},swf:"webuploader/Uploader.swf",disableGlobalDnd:true,chunked:true,server:urlUploadFile,fileNumLimit:10,fileSizeLimit:10*1024*1024,fileSingleSizeLimit:100*1024*1024});uploader.addButton({id:"#filePicker2",label:"&nbsp;继续添加"});function p(B){var C=$('<li id="'+B.id+'">'+'<p class="title">'+B.name+"</p>"+'<p class="imgWrap"></p>'+'<p class="progress"><span></span></p>'+"</li>"),z=$('<div class="file-panel">'+'<span class="cancel">删除</span>'+'<span class="rotateRight">向右旋转</span>'+'<span class="rotateLeft">向左旋转</span></div>').appendTo(C),y=C.find("p.progress span"),x=C.find("p.imgWrap"),A=$('<p class="error"></p>'),w=function(D){switch(D){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}A.text(text).appendTo(C)};if(B.getStatus()==="invalid"){w(B.statusText)}else{x.text("预览中");uploader.makeThumb(B,function(E,F){if(E){x.text("不能预览");return}var D=$('<img src="'+F+'">');x.empty().append(D)},thumbnailWidth,thumbnailHeight);percentages[B.id]=[B.size,0];B.rotation=0}B.on("statuschange",function(E,D){if(D==="progress"){y.hide().width(0)}else{if(D==="queued"){C.off("mouseenter mouseleave");z.remove()}}if(E==="error"||E==="invalid"){console.log(B.statusText);w(B.statusText);percentages[B.id][1]=1}else{if(E==="interrupt"){w("interrupt")}else{if(E==="queued"){percentages[B.id][1]=0}else{if(E==="progress"){A.remove();y.css("display","block")}else{if(E==="complete"){C.append('<span class="success"></span>')}}}}}C.removeClass("state-"+D).addClass("state-"+E)});C.on("mouseenter",function(){z.stop().animate({height:30})});C.on("mouseleave",function(){z.stop().animate({height:0})});z.on("click","span",function(){var D=$(this).index(),E;switch(D){case 0:uploader.removeFile(B);return;case 1:B.rotation+=90;break;case 2:B.rotation-=90;break}if(supportTransition){E="rotate("+B.rotation+"deg)";x.css({"-webkit-transform":E,"-mos-transform":E,"-o-transform":E,"transform":E})}else{x.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((B.rotation/90)%4+4)%4)+")")}});C.appendTo(j)}function v(w){var x=$("#"+w.id);delete percentages[w.id];d();x.off().find(".file-panel").off().end().remove()}function d(){var w=0,z=0,x=m.children(),y;$.each(percentages,function(B,A){z+=A[0];w+=A[0]*A[1]});y=z?w/z:0;x.eq(0).text(Math.round(y*100)+"%");x.eq(1).css("width",Math.round(y*100)+"%");e()}function e(){var x="",w;if(state==="ready"){x="选中"+u+"张图片，共"+WebUploader.formatSize(l)+"。"}else{if(state==="confirm"){w=uploader.getStats();if(w.uploadFailNum){x="已成功上传"+w.successNum+"张图片，"+w.uploadFailNum+'张图片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{w=uploader.getStats();x="共"+u+"张（"+WebUploader.formatSize(l)+"），已上传"+w.successNum+"张";if(w.uploadFailNum){x+="，失败"+w.uploadFailNum+"张"}}}c.html(x)}function o(y){var x,w;if(y===state){return}a.removeClass("state-"+state);a.addClass("state-"+y);state=y;switch(state){case"pedding":g.removeClass("element-invisible");j.parent().removeClass("filled");j.hide();r.addClass("element-invisible");uploader.refresh();break;case"ready":g.addClass("element-invisible");$("#filePicker2").removeClass("element-invisible");j.parent().addClass("filled");j.show();r.removeClass("element-invisible");uploader.refresh();break;case"confirm":m.hide();a.addClass("disabled");$("#filePicker2").addClass("element-invisible");w=uploader.getStats();if(w.successNum&&!w.uploadFailNum){o("finish");return}break;case"finish":w=uploader.getStats();if(w.successNum){location.href=t}else{location.reload()}break}e()}uploader.onUploadProgress=function(y,w){var z=$("#"+y.id),x=z.find(".progress span");x.css("width",w*100+"%");percentages[y.id][1]=w;d()};uploader.onFileQueued=function(w){u++;l+=w.size;if(u===1){g.addClass("element-invisible");
r.show()}p(w);o("ready");d()};uploader.onFileDequeued=function(w){u--;l-=w.size;if(!u){o("pedding")}v(w);d()};uploader.on("all",function(x){var w;switch(x){case"uploadFinished":o("confirm");break;case"startUpload":o("uploading");break}});uploader.onError=function(x){var w;switch(x){case"F_DUPLICATE":w="文件名重复!";break;case"F_EXCEED_SIZE":w="图片过大!";break;case"Q_EXCEED_SIZE_LIMIT":w="图片队列总大小过大!";break;case"Q_EXCEED_NUM_LIMIT":w="文件数量过多!";break;case"Q_TYPE_DENIED":w="请选择jpg/jpeg/png或gif格式的图片!";break}J.showToast(w,"",2000)};uploader.on("startUpload",function(){uploader.option("formData",{"booking[id]":s.id,})});uploader.on("uploadFinished",function(w,x){});uploader.on("uploadSuccess",function(w,x){});uploader.on("uploadError",function(w,x){});uploader.on("uploadAccept",function(w,x){if(x.status!="ok"){return false}});a.on("click",function(){if($(this).hasClass("disabled")||$(this).hasClass("ui-state-disabled")){return false}var y=i.attr("data-checkCode");var w=i.serializeArray();var x=h.form();if(x){if($("#checkUser").attr("value")==1){b()}else{var z=$("#booking_captcha_code").val();$.ajax({type:"post",url:y+"?co_code="+z,data:w,success:function(A){if(A.status=="ok"){b()}else{$("#booking_captcha_code-error").remove();$("#captchaCode").after('<div id="booking_captcha_code-error" class="error">'+A.error+"</div>");$("#booking_captcha_code").focus()}}})}}});c.on("click",".retry",function(){uploader.retry()});c.on("click",".ignore",function(){location.href=t});a.addClass("state-"+state);d();function b(){disabledBtn(q);k=i.attr("data-actionurl");var x=i.serializeArray();var w=structure_formdata("booking",x);var y=do_encrypt(w,pubkey);var z={param:y};$.ajax({type:"post",url:k,data:z,success:function(A){console.log(A);if(A.status=="ok"){s.id=A.booking.id;t=t+"?refNo="+A.salesOrderRefNo;if(state=="ready"){uploader.upload()}else{location.href=t}}else{i.find("div.error").remove();isfocus=true;for(error in A.errors){errerMsg=A.errors[error];inputKey="#booking_"+error;$(inputKey).focus();$(inputKey).after("<div class='error'>"+errerMsg+"</div> ")}enableBtn(q)}},error:function(A,C,B){enableBtn(q);console.log(A);console.log(C);console.log(B)},complete:function(){return}})}var h=i.validate({rules:{"booking[doctor_name]":{maxlength:50},"booking[hospital_name]":{maxlength:50},"booking[hp_dept_name]":{maxlength:50},"booking[contact_name]":{required:true,maxlength:50},"booking[captcha_code]":{required:true},"booking[mobile]":{required:true,isMobile:true},"booking[verify_code]":{required:true,digits:true,maxlength:6,minlength:6},"booking[disease_name]":{required:true,maxlength:50},"booking[disease_detail]":{required:true,minlength:10,maxlength:1000},"booking[remark]":{required:true,maxlength:500}},messages:{"booking[doctor_name]":{maxlength:"姓名太长"},"booking[hospital_name]":{maxlength:"医院名称太长"},"booking[hp_dept_name]":{maxlength:"科室名称太长"},"booking[contact_name]":{required:"请填写患者姓名",maxlength:"患者姓名太长"},"booking[captcha_code]":{required:"请填写图形验证码"},"booking[mobile]":{required:"请填写手机号码",isMobile:"请输入正确的中国手机号码"},"booking[verify_code]":{required:"请输入验证码",digits:"验证码不正确",maxlength:"验证码不正确",minlength:"验证码不正确"},"booking[disease_name]":{required:"请填写疾病诊断",maxlength:"请将字数控制在50以内"},"booking[disease_detail]":{required:"请填写病情",minlength:"请至少填写10个字",maxlength:"请将字数控制在1000以内"}},errorElement:"div",errorPlacement:function(w,x){x.parents(".ui-field-contain").find("div.error").remove();w.appendTo(x.parents(".ui-field-contain"))}})});