$(function(){var num=0;var domFormCorp=$("#corpFiles-form"),bookingForm=$("#booking-form"),btnSubmit=$("#btnSubmit"),returnCorpResult=true;var uploader=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles1",container:"container1",drop_element:"container1",max_file_size:"1000mb",flash_swf_url:"bower_components/plupload/js/Moxie.swf",dragdrop:true,chunk_size:"4mb",uptoken_url:$("#uptokenCorp_url").val(),domain:$("#domainCorp").val(),get_new_uptoken:false,auto_start:false,log_level:5,init:{"FilesAdded":function(up,files){for(var i=0;i<files.length;i++){var uploadFile=true;$("#fsUploadProgress1").find(".progressName").each(function(){if(($(this).html()==files[i].name)&&($(this).next(".progressFileSize").html()==plupload.formatSize(files[i].size).toUpperCase())){$("#jingle_toast").find("a").text("该文件已被选择");$("#jingle_toast").show();setTimeout(function(){$("#jingle_toast").hide()},1000);uploadFile=false}});if(uploadFile){$("#pickfiles1").find("span").text("继续添加");$("table").show();$("#success").hide();plupload.each(files,function(file){var progress=new FileProgress(file,"fsUploadProgress1");progress.setStatus("等待...");progress.bindUploadCancel(up)})}}},"BeforeUpload":function(up,file){var progress=new FileProgress(file,"fsUploadProgress1");var chunk_size=plupload.parseSize(this.getOption("chunk_size"));if(up.runtime==="html5"&&chunk_size){progress.setChunkProgess(chunk_size)}},"UploadProgress":function(up,file){var progress=new FileProgress(file,"fsUploadProgress1");var chunk_size=plupload.parseSize(this.getOption("chunk_size"));progress.setProgress(file.percent+"%",file.speed,chunk_size)},"UploadComplete":function(){uploader2.start()},"FileUploaded":function(up,file,info){var progress=new FileProgress(file,"fsUploadProgress1");var infoJson=eval("("+info+")");progress.setComplete(up,info);var formdata=new FormData();var fileExtension=file.name.substring(file.name.lastIndexOf(".")+1);formdata.append("corp[booking_id]",$("#bookingCorp_id").val());formdata.append("corp[file_size]",file.size);formdata.append("corp[mime_type]",file.type);formdata.append("corp[file_name]",file.name);formdata.append("corp[file_url]",file.name);formdata.append("corp[file_ext]",fileExtension);formdata.append("corp[remote_domain]",domFormCorp.find("#domainCorp").val());formdata.append("corp[remote_file_key]",infoJson.key);$.ajax({url:domFormCorp.attr("data-url-uploadCorpfile"),data:formdata,type:"post",contentType:false,processData:false,success:function(data){if(data.status=="ok"){}else{returnCorpResult=false}},error:function(data){console.log("数据存储失败");returnCorpResult=false}})},"Error":function(up,err,errTip){returnCorpResult=false;console.log("错误信息"+errTip);$("table").show();var progress=new FileProgress(err.file,"fsUploadProgress1");progress.setError();progress.setStatus(errTip)},"Key":function(up,file){var key=(new Date()).getTime()+""+Math.floor(Math.random()*100);return key}}});uploader.bind("FileUploaded",function(){});var domForm=$("#uploadFile-form");returnResult=true;var Q2=new QiniuJsSDK();var uploader2=Q2.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles2",container:"container2",drop_element:"container2",max_file_size:"1000mb",flash_swf_url:"bower_components/plupload/js/Moxie.swf",dragdrop:true,chunk_size:"4mb",uptoken_url:$("#uptoken_url").val(),domain:$("#domain").val(),get_new_uptoken:false,auto_start:false,log_level:5,init:{"FilesAdded":function(up,files){for(var i=0;i<files.length;i++){var uploadFile=true;if(($("#fsUploadProgress2").find(".progressContainer").length)>=9){$("#jingle_toast").find("a").text("影像资料不能超过9张");$("#jingle_toast").show();setTimeout(function(){$("#jingle_toast").hide()},1000);uploadFile=false}$("#fsUploadProgress2").find(".progressName").each(function(){if(($(this).html()==files[i].name)&&($(this).next(".progressFileSize").html()==plupload.formatSize(files[i].size).toUpperCase())){$("#jingle_toast").find("a").text("该文件已被选择");$("#jingle_toast").show();setTimeout(function(){$("#jingle_toast").hide()},1000);uploadFile=false}});if(uploadFile){$("#pickfiles2").find("span").text("继续添加");$("table").show();$("#success").hide();plupload.each(files,function(file){var progress=new FileProgress(file,"fsUploadProgress2");progress.setStatus("等待...");progress.bindUploadCancel(up)})}}},"BeforeUpload":function(up,file){var progress=new FileProgress(file,"fsUploadProgress2");var chunk_size=plupload.parseSize(this.getOption("chunk_size"));if(up.runtime==="html5"&&chunk_size){progress.setChunkProgess(chunk_size)}},"UploadProgress":function(up,file){var progress=new FileProgress(file,"fsUploadProgress2");var chunk_size=plupload.parseSize(this.getOption("chunk_size"));progress.setProgress(file.percent+"%",file.speed,chunk_size)},"UploadComplete":function(){$("#jingle_popup").show();$("#jingle_popup_mask").show();enableBtnAndriod(btnSubmit)},"FileUploaded":function(up,file,info){var progress=new FileProgress(file,"fsUploadProgress2");var infoJson=eval("("+info+")");progress.setComplete(up,info);
var formdata=new FormData();var fileExtension=file.name.substring(file.name.lastIndexOf(".")+1);formdata.append("booking[booking_id]",$("#bookingCorp_id").val());formdata.append("booking[file_size]",file.size);formdata.append("booking[mime_type]",file.type);formdata.append("booking[file_name]",file.name);formdata.append("booking[file_url]",file.name);formdata.append("booking[file_ext]",fileExtension);formdata.append("booking[remote_domain]",domForm.find("#domain").val());formdata.append("booking[remote_file_key]",infoJson.key);$.ajax({url:domForm.attr("data-url-uploadfile"),data:formdata,type:"post",contentType:false,processData:false,success:function(data){if(data.status=="ok"){}else{returnResult=false}},error:function(data){console.log("数据存储失败");returnResult=false}})},"Error":function(up,err,errTip){returnResult=false;console.log("错误信息"+errTip);$("table").show();var progress=new FileProgress(err.file,"fsUploadProgress2");progress.setError();progress.setStatus(errTip)},"Key":function(up,file){var key=(new Date()).getTime()+""+Math.floor(Math.random()*100);return key}}});uploader2.bind("FileUploaded",function(){});$.validator.addMethod("isMobile",function(value,element){var length=value.length;var mobile=/^(13[0-9]{9})|(18[0-9]{9})|(14[0-9]{9})|(17[0-9]{9})|(15[0-9]{9})$/;return this.optional(element)||(length==11&&mobile.test(value))},"请填写正确的手机号码");var validator=bookingForm.validate({rules:{"booking[corporate_name]":{required:true,maxlength:50},"booking[corp_staff_rel]":{required:true},"booking[doctor_name]":{maxlength:50},"booking[hospital_name]":{maxlength:50},"booking[hp_dept_name]":{maxlength:50},"booking[contact_name]":{required:true,maxlength:50},"booking[captcha_code]":{required:true},"booking[mobile]":{required:true,isMobile:true},"booking[verify_code]":{required:true,digits:true,maxlength:6,minlength:6},"booking[disease_name]":{required:true,maxlength:50},"booking[disease_detail]":{required:true,minlength:10,maxlength:1000},"booking[remark]":{required:true,maxlength:500}},messages:{"booking[corporate_name]":{required:"请填写医生企业名称",maxlength:"企业名称太长"},"booking[corp_staff_rel]":{required:"请选择与患者的关系"},"booking[doctor_name]":{maxlength:"姓名太长"},"booking[hospital_name]":{maxlength:"医院名称太长"},"booking[hp_dept_name]":{maxlength:"科室名称太长"},"booking[contact_name]":{required:"请填写患者姓名",maxlength:"患者姓名太长"},"booking[captcha_code]":{required:"请填写图形验证码"},"booking[mobile]":{required:"请填写手机号码",isMobile:"请输入正确的中国手机号码"},"booking[verify_code]":{required:"请输入验证码",digits:"验证码不正确",maxlength:"验证码不正确",minlength:"验证码不正确"},"booking[disease_name]":{required:"请填写疾病诊断",maxlength:"请将字数控制在50以内"},"booking[disease_detail]":{required:"请填写病情",minlength:"请至少填写10个字",maxlength:"请将字数控制在1000以内"}},errorElement:"div",errorPlacement:function(error,element){element.parents(".ui-field-contain").find("div.error").remove();error.appendTo(element.parents(".ui-field-contain"))},});btnSubmit.click(function(){var patientInputCount=$(".patient .MultiFile-applied").length-1;var corpInputCount=$("#fsUploadProgress1").find("td").length;var corporate_name=bookingForm.find("#booking_corporate_name").val();if(corpInputCount<1){$(".corpTip").show();setTimeout(function(){$(".corpTip").hide()},1000)}else{if(!corporate_name){$("#booking_corporate_name_show").parents("li").find("div.error").remove();$("#booking_corporate_name_show").after("<div class='error'>请填写医生企业名称</div> ");$("#booking_corporate_name_show").focus();validator.form()}else{var urlCheckCode=bookingForm.attr("data-checkCode");var formdata=bookingForm.serializeArray();var bool=validator.form();if(bool){var captchaCode=$("#booking_captcha_code").val();$.ajax({type:"post",url:urlCheckCode+"?co_code="+captchaCode,data:formdata,success:function(data){if(data.status=="ok"){formAjaxSubmit()}else{$("#booking_captcha_code-error").remove();$("#captchaCode").after('<div id="booking_captcha_code-error" class="error">'+data.error+"</div>");$("#booking_captcha_code").focus()}}})}}}});function formAjaxSubmit(){disabledBtnAndriod(btnSubmit);actionUrl=bookingForm.attr("data-actionurl");var formdata=bookingForm.serializeArray();var dataArray=structure_formdata("booking",formdata);var encryptContext=do_encrypt(dataArray,pubkey);var param={param:encryptContext};$.ajax({type:"post",url:actionUrl,data:param,success:function(data){if(data.status=="ok"){$("#booking_id").val(data.booking.id);$("#bookingCorp_id").val(data.booking.id);uploader.start()}else{bookingForm.find("div.error").remove();$(".form-wrapper").find("div.error").remove();isfocus=true;for(error in data.errors){inputKey="#booking_"+error;if(error=="corporate_name"){inputKey="#booking_"+error+"_show"}errerMsg=data.errors[error];$(inputKey).focus();$(inputKey).after("<div class='error'>"+errerMsg+"</div> ")}enableBtnAndriod(btnSubmit)}},error:function(XmlHttpRequest,textStatus,errorThrown){enableBtnAndriod(btnSubmit);console.log(XmlHttpRequest);console.log(textStatus);console.log(errorThrown)},complete:function(){}})}$("#container").on("dragenter",function(e){e.preventDefault();
$("#container").addClass("draging");e.stopPropagation()}).on("drop",function(e){e.preventDefault();$("#container").removeClass("draging");e.stopPropagation()}).on("dragleave",function(e){e.preventDefault();$("#container").removeClass("draging");e.stopPropagation()}).on("dragover",function(e){e.preventDefault();$("#container").addClass("draging");e.stopPropagation()});$("#show_code").on("click",function(){$("#myModal-code").modal();$("pre code").each(function(i,e){hljs.highlightBlock(e)})});$("body").on("click","table button.btn",function(){$(this).parents("tr").next().toggle()});$("#up_load").on("click",function(){uploader.start()});var getRotate=function(url){if(!url){return 0}var arr=url.split("/");for(var i=0,len=arr.length;i<len;i++){if(arr[i]==="rotate"){return parseInt(arr[i+1],10)}}return 0};$("#myModal-img .modal-body-footer").find("a").on("click",function(){var img=$("#myModal-img").find(".modal-body img");var key=img.data("key");var oldUrl=img.attr("src");var originHeight=parseInt(img.data("h"),10);var fopArr=[];var rotate=getRotate(oldUrl);if(!$(this).hasClass("no-disable-click")){$(this).addClass("disabled").siblings().removeClass("disabled");if($(this).data("imagemogr")!=="no-rotate"){fopArr.push({"fop":"imageMogr2","auto-orient":true,"strip":true,"rotate":rotate,"format":"png"})}}else{$(this).siblings().removeClass("disabled");var imageMogr=$(this).data("imagemogr");if(imageMogr==="left"){rotate=rotate-90<0?rotate+270:rotate-90}else{if(imageMogr==="right"){rotate=rotate+90>360?rotate-270:rotate+90}}fopArr.push({"fop":"imageMogr2","auto-orient":true,"strip":true,"rotate":rotate,"format":"png"})}$("#myModal-img .modal-body-footer").find("a.disabled").each(function(){var watermark=$(this).data("watermark");var imageView=$(this).data("imageview");var imageMogr=$(this).data("imagemogr");if(watermark){fopArr.push({fop:"watermark",mode:1,image:"http://www.b1.qiniudn.com/images/logo-2.png",dissolve:100,gravity:watermark,dx:100,dy:100})}if(imageView){var height;switch(imageView){case"large":height=originHeight;break;case"middle":height=originHeight*0.5;break;case"small":height=originHeight*0.1;break;default:height=originHeight;break}fopArr.push({fop:"imageView2",mode:3,h:parseInt(height,10),q:100,format:"png"})}if(imageMogr==="no-rotate"){fopArr.push({"fop":"imageMogr2","auto-orient":true,"strip":true,"rotate":0,"format":"png"})}});var newUrl=Qiniu.pipeline(fopArr,key);var newImg=new Image();img.attr("src","images/loading.gif");newImg.onload=function(){img.attr("src",newUrl);img.parent("a").attr("href",newUrl)};newImg.src=newUrl;return false})});